<!doctype html>
<html lang="en">

<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
  
  <meta name="generator" content="Hugo 0.155.3">

  
  <meta name="description" content="Some description">
  

  
  <link rel="apple-touch-icon" sizes="180x180" href="https://xshiraori.github.io/apple-touch-icon.png">

  
  <link rel="icon" type="image/png" sizes="32x32" href="https://xshiraori.github.io/favicon-32x32.png">

  
  <link rel="icon" type="image/png" sizes="16x16" href="https://xshiraori.github.io/favicon-16x16.png">

  
  <link rel="manifest" href="https://xshiraori.github.io/site.webmanifest">

  
  <link rel="mask-icon" href="https://xshiraori.github.io/safari-pinned-tab.svg" color="#5bbad5">

  <meta name="msapplication-TileColor" content="#da532c">

  <meta name="theme-color" content="#ffffff">

  
  <link rel="stylesheet" href="https://xshiraori.github.io/css/bootstrap.min.css" />

  
  <title>Reverse engineering Windows&#39; TCP PartitionTable, bringing back Volatility&#39;s good old netscan module | xsh</title>
  

  <style>
body {
  min-width: 300px;
}

.custom-navbar {
  margin-bottom: 1em;
  height: 60px;
}

.custom-navbar a {
  display: inline-block; 
  padding: 18px 0;
  margin-right: 1em; 
  font-weight: bold; 
}

.custom-navbar a:hover,
.custom-navbar a:focus {
  text-decoration: none; 
}

@media print {
  .custom-navbar {
    display: none;
  }
}

article {
  padding-bottom: 1em;
}

img {
  max-width: 100%;
}


body {
  background-color: #fff;
}



body {
  color: #212529;
}



a {
  color: #007bff;
}



a:hover,
a:focus {
  color: #0056b3;
}



.custom-navbar {
  background-color: #212529;
}



.custom-navbar a {
  color: rgba(255, 255, 255, 0.75);
}



.custom-navbar a:hover,
.custom-navbar a:focus {
  color: rgba(255, 255, 255, 1);
}



.container {
  max-width: 800px;
}



pre {
  display: block;
  padding: 9.5px;
  word-break: break-all;
  word-wrap: break-word;
  background-color: #f5f5f5;
  border: 1px solid #ccc;
  border-radius: 4px;
}

pre code {
  padding: 0;
  font-size: inherit;
  color: inherit; 
  white-space: pre-wrap;
  background-color: transparent;
  border: none;
  border-radius: 0;
}

code {
  padding: 2px 4px;
  color: inherit; 
  background-color: #f5f5f5;
  border: 1px solid #ccc;
  border-radius: 4px;
  font-size: .9em;
}



blockquote,
.blockquote {
  padding: 10px 20px;
  margin: 0 0 20px;
  font-size: 1em;
  border-left: 5px solid #6c757d;
}

</style>
</head>

<body>
  <nav class="custom-navbar">
  <div class="container">
    
    <a href="/">Posts</a>
    
    <a href="/about/">About</a>
    
  </div>
</nav>
  
  <div class="container">
    <article>
      <h1>Reverse engineering Windows&rsquo; TCP PartitionTable, bringing back Volatility&rsquo;s good old netscan module</h1>
<p>
  <small class="text-secondary">
  
  
  Feb 10, 2026, updated Feb 11, 2026
  </small>
  
  

</p>
<p>We start tracing from <code>GetTcpTable</code>, which is just a wrapper over <code>GetTcpTableInternal</code>. This function is responsible for processing the TCP table data returned from a call to <code>NsiAllocateAndGetTable</code> .</p>
<p><code>NsiAllocateAndGetTable</code> carries our analysis to the kernel side, by invoking the handler for <code>0x12001B</code>  IOCTL code of the <code>nsiproxy.sys</code></p>
<p>nsiproxy is a broker between the user mode clients and the kernel mode nsi providers, let&rsquo;s take a look at <code>nsiproxy!NsippDispatch</code> to see which provider it will have to trigger in our case.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#66d9ef">switch</span> ( LowPart )
</span></span><span style="display:flex;"><span>  {
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">case</span> <span style="color:#ae81ff">0x12001B</span><span style="color:#f92672">:</span>
</span></span><span style="display:flex;"><span>      Parameter <span style="color:#f92672">=</span> <span style="color:#a6e22e">NsippEnumerateObjectsAllParameters</span>(Parameters, Options, RequestorMode, <span style="color:#f92672">&amp;</span>a2<span style="color:#f92672">-&gt;</span>IoStatus.Information);
</span></span><span style="display:flex;"><span>      <span style="color:#66d9ef">break</span>;
</span></span><span style="display:flex;"><span>...
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#66d9ef">__int64</span> nsiproxy<span style="color:#f92672">!</span><span style="color:#a6e22e">NsippEnumerateObjectsAllParameters</span>(__int128 <span style="color:#f92672">*</span>Address, SIZE_T Length, <span style="color:#66d9ef">char</span> a3, _QWORD <span style="color:#f92672">*</span>a4)
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>    ... <span style="color:#75715e">// here it will probe the buffer for write
</span></span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">NsiEnumerateObjectsAllParametersEx</span>(v14);
</span></span><span style="display:flex;"><span>    ...
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#75715e">// netio!NsiEnumerateObjectsAllParametersEx
</span></span></span><span style="display:flex;"><span><span style="color:#66d9ef">__int64</span> <span style="color:#a6e22e">NsiEnumerateObjectsAllParametersEx</span>(<span style="color:#66d9ef">__int64</span> req)
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">for</span> (entry <span style="color:#f92672">=</span> NsiNmpList; entry <span style="color:#f92672">!=</span> <span style="color:#f92672">&amp;</span>NsiNmpList; entry <span style="color:#f92672">=</span> entry<span style="color:#f92672">-&gt;</span>Flink)
</span></span><span style="display:flex;"><span>    {
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> (entry<span style="color:#f92672">-&gt;</span>ModuleId<span style="color:#f92672">-&gt;</span>Type <span style="color:#f92672">==</span> <span style="color:#ae81ff">1</span> <span style="color:#f92672">&amp;&amp;</span> 
</span></span><span style="display:flex;"><span>            <span style="color:#a6e22e">memcmp</span>(<span style="color:#f92672">&amp;</span>entry<span style="color:#f92672">-&gt;</span>ModuleId<span style="color:#f92672">-&gt;</span>Guid, req<span style="color:#f92672">-&gt;</span>ModuleId<span style="color:#f92672">-&gt;</span>Guid, <span style="color:#ae81ff">16</span>) <span style="color:#f92672">==</span> <span style="color:#ae81ff">0</span>)
</span></span><span style="display:flex;"><span>        {
</span></span><span style="display:flex;"><span>            provider <span style="color:#f92672">=</span> entry<span style="color:#f92672">-&gt;</span>DispatchTable;
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">break</span>;
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    tableEntry <span style="color:#f92672">=</span> <span style="color:#f92672">&amp;</span>provider<span style="color:#f92672">-&gt;</span>InformationObject[req<span style="color:#f92672">-&gt;</span>TableIndex];
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> tableEntry<span style="color:#f92672">-&gt;</span><span style="color:#a6e22e">EnumerateObjects</span>(req);
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p><code>NsiEnumerateObjectsAllParametersEx</code> does a lookup on NsiNpmList hoping to find the provider specified by the caller. It will find the <code>TcpInformationObject</code> of the requested module and execute the handler.</p>
<p>the NsiNpmList looks to belong to be a structure like this</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#66d9ef">struct</span> _NMP_MODULE{
</span></span><span style="display:flex;"><span>    DWORD Length;
</span></span><span style="display:flex;"><span>    DWORD Type; <span style="color:#75715e">// set to 1 for the GUID
</span></span></span><span style="display:flex;"><span>    DWORD Guid[<span style="color:#ae81ff">4</span>];
</span></span><span style="display:flex;"><span>};
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">struct</span> _NMP_CONTEXT{
</span></span><span style="display:flex;"><span>    LIST_ENTRY <span style="color:#f92672">*</span>Flink;
</span></span><span style="display:flex;"><span>    LIST_ENTRY <span style="color:#f92672">*</span>Blink;
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">struct</span> _NMP_MODULE <span style="color:#f92672">*</span>ModuleId;
</span></span><span style="display:flex;"><span>    QWORD Unknown;
</span></span><span style="display:flex;"><span>    QWORD<span style="color:#f92672">*</span> ProviderDispatch;
</span></span><span style="display:flex;"><span>    QWORD<span style="color:#f92672">*</span> DispatchTable; <span style="color:#75715e">// in TCP case it&#39;s TcpNsiInterfaceDispatch
</span></span></span><span style="display:flex;"><span>};
</span></span></code></pre></div><p>for the TCP case the provider GUID is <code>{eb004a03-9b1a-11d4-9123-0050047759bc}</code>, I&rsquo;ve found it on the 4th entry.</p>
<pre tabindex="0"><code>2: kd&gt; dq ffffc48d`3bdf0178 &lt;- this is the _NMP_CONTEXT entry
ffffc48d`3bdf0178  ffffc48d`3bdf0318 ffffc48d`3bddb4b8
ffffc48d`3bdf0188  fffff801`1dd89130 00000000`00000004
ffffc48d`3bdf0198  ffffc48d`3e5fecc0 fffff801`1ddc17a8 &lt;- the dispatcher
ffffc48d`3bdf01a8  00000000`00000000 ffffc48d`3bdf7b5c
ffffc48d`3bdf01b8  ffffc48d`3b89cb80 00000001`00000002
ffffc48d`3bdf01c8  ffffc48d`3bdf01c8 ffffc48d`3bdf01c8
ffffc48d`3bdf01d8  ffffc48d`3e7fc388 ffffc48d`3bdf0210
ffffc48d`3bdf01e8  00000000`00000000 00000000`00000100

2: kd&gt; dq fffff801`1dd89130
fffff801`1dd89130  00000001`00000018 11d49b1a`eb004a03 &lt;- here is the guid
fffff801`1dd89140  bc597704`50002391 00000001`00000018
fffff801`1dd89150  11d49b1a`eb004a07 bc597704`50002391
fffff801`1dd89160  00000001`00000018 11d49b1a`eb004a0d
fffff801`1dd89170  bc597704`50002391 00000001`00000018
fffff801`1dd89180  11d49b1a`eb004a19 bc597704`50002391
fffff801`1dd89190  00000001`00000018 11d49b1a`eb004a1d
fffff801`1dd891a0  bc597704`50002391 00000001`00000018

2: kd&gt; dq fffff801`1ddc17a8
fffff801`1ddc17a8  00000028`00100000 fffff801`1ddbf500 &lt;- TcpInformationObject
fffff801`1ddc17b8  00000006`00100000 fffff801`1ddc0560 &lt;- UdpInformationObject
fffff801`1ddc17c8  00000001`00100000 fffff801`1ddc0810 &lt;- RawInformationObject
fffff801`1ddc17d8  00000000`00000000 ffffc48d`3bde3a10
fffff801`1ddc17e8  00000000`00000000 80000000`00000000
fffff801`1ddc17f8  00000000`00000000 00000001`00000000
fffff801`1ddc1808  00000000`000400ff fffff801`1ddc35a0
fffff801`1ddc1818  fffff801`1dd94a30 fffff801`1dd94a50

2: kd&gt; dq fffff801`1ddbf500 + (0x68 * 3) + 0x40 L1 &lt;- 4th entry, provided from UM
fffff801`1ddbf678  fffff801`1dcb5d80

2: kd&gt; u fffff801`1dcb5d80
tcpip!TcpEnumerateAllConnections:
fffff801`1dcb5d80 4883ec28        sub     rsp,28h
fffff801`1dcb5d84 ba02000000      mov     edx,2
fffff801`1dcb5d89 e8f6020000      call    tcpip!TcpEnumerateConnectionType (fffff801`1dcb6084)
fffff801`1dcb5d8e 4883c428        add     rsp,28h
fffff801`1dcb5d92 c3              ret
</code></pre><p>We can see that GetTcpTable hardcoded the fourth entry for the kernel module to use it:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none;"><code class="language-c" data-lang="c"><span style="display:flex;"><span>ULONG <span style="color:#a6e22e">GetTcpTable</span>(PMIB_TCPTABLE TcpTable, PULONG SizePointer, BOOL Order)
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span> <span style="color:#66d9ef">return</span> <span style="color:#a6e22e">GetTcpTableInternal</span>(TcpTable, SizePointer, Order, <span style="color:#ae81ff">3</span>, <span style="color:#ae81ff">0</span>);
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>So far so good, we found the function responsible for fetching, <code>TcpEnumerateConnectionType(2)</code> is the call that is responsible for fetching the table data. <code>2</code> stands for <code>ENUMERATE_CONNECTIONS</code>, there are some other options available, which I would call them:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#66d9ef">enum</span> _TCP_ENUMERATE_TYPE
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>    CONNECTIONS <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>,
</span></span><span style="display:flex;"><span>    LISTENERS <span style="color:#f92672">=</span> <span style="color:#ae81ff">1</span>,
</span></span><span style="display:flex;"><span>    ALL <span style="color:#f92672">=</span> <span style="color:#ae81ff">2</span>,
</span></span><span style="display:flex;"><span>    BOUND_ENDPOINTS <span style="color:#f92672">=</span> <span style="color:#ae81ff">3</span>
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p><code>TcpEnumerateConnectionType</code> is responsible for iterating the partition table, which consist of connections with the status of <code>ESTABLISHED_TCB</code>, <code>TIME_WAIT</code> and <code>SYN_TCB</code> (in memory order).</p>
<p>The pseudocode for this function looks like below:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#66d9ef">__int64</span> <span style="color:#a6e22e">TcpEnumerateConnections</span>(AF, KeyBuf, RwBuf, RoBuf, MaxEntries, <span style="color:#f92672">*</span>Count)
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>    AfObject <span style="color:#f92672">=</span> <span style="color:#a6e22e">InetFindAndReferenceAf</span>(<span style="color:#f92672">&amp;</span>TcpInetTransport, AF);
</span></span><span style="display:flex;"><span>    CompartmentId <span style="color:#f92672">=</span> <span style="color:#a6e22e">NdisGetThreadObjectCompartmentId</span>(<span style="color:#a6e22e">KeGetCurrentThread</span>());
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">for</span> (i <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>; i <span style="color:#f92672">&lt;</span> PartitionCount; i<span style="color:#f92672">++</span>)
</span></span><span style="display:flex;"><span>    {
</span></span><span style="display:flex;"><span>        Partition <span style="color:#f92672">=</span> <span style="color:#f92672">&amp;</span>PartitionTable[i]; 
</span></span><span style="display:flex;"><span>        HashTables <span style="color:#f92672">=</span> Partition<span style="color:#f92672">-&gt;</span>HashTables;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">// established TCBs (hash table [0])
</span></span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">RtlInitWeakEnumerationHashTable</span>(<span style="color:#f92672">&amp;</span>HashTables[<span style="color:#ae81ff">0</span>], <span style="color:#f92672">&amp;</span>Enum);
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">while</span> (entry <span style="color:#f92672">=</span> <span style="color:#a6e22e">RtlWeaklyEnumerateEntryHashTable</span>(<span style="color:#f92672">&amp;</span>HashTables[<span style="color:#ae81ff">0</span>], <span style="color:#f92672">&amp;</span>Enum))
</span></span><span style="display:flex;"><span>        {
</span></span><span style="display:flex;"><span>            Tcb <span style="color:#f92672">=</span> entry <span style="color:#f92672">-</span> <span style="color:#ae81ff">0x28</span>; <span style="color:#75715e">// the size of hash table struct
</span></span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">if</span> (Tcb<span style="color:#f92672">-&gt;</span>Flags <span style="color:#f92672">&amp;</span> <span style="color:#ae81ff">4</span> <span style="color:#f92672">&amp;&amp;</span> Tcb<span style="color:#f92672">-&gt;</span>AF <span style="color:#f92672">==</span> AfObject <span style="color:#f92672">&amp;&amp;</span> Tcb<span style="color:#f92672">-&gt;</span>Compartment <span style="color:#f92672">==</span> CompartmentId)
</span></span><span style="display:flex;"><span>            {
</span></span><span style="display:flex;"><span>                KeyBuf[<span style="color:#f92672">*</span>Count] <span style="color:#f92672">=</span> { LocalAddr, LocalPort, RemoteAddr, RemotePort};
</span></span><span style="display:flex;"><span>                RwBuf[<span style="color:#f92672">*</span>Count]  <span style="color:#f92672">=</span> { <span style="color:#a6e22e">PsGetProcessId</span>(Tcb<span style="color:#f92672">-&gt;</span>Process), Timestamps };
</span></span><span style="display:flex;"><span>                RoBuf[<span style="color:#f92672">*</span>Count]  <span style="color:#f92672">=</span> Tcb<span style="color:#f92672">-&gt;</span>State <span style="color:#f92672">+</span> <span style="color:#ae81ff">1</span>;
</span></span><span style="display:flex;"><span>            }
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">// SYN TCB (hash table [3])
</span></span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">RtlInitWeakEnumerationHashTable</span>(<span style="color:#f92672">&amp;</span>HashTables[<span style="color:#ae81ff">3</span>], <span style="color:#f92672">&amp;</span>Enum);
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">while</span> (entry <span style="color:#f92672">=</span> <span style="color:#a6e22e">RtlWeaklyEnumerateEntryHashTable</span>(<span style="color:#f92672">&amp;</span>HashTables[<span style="color:#ae81ff">3</span>], <span style="color:#f92672">&amp;</span>Enum))
</span></span><span style="display:flex;"><span>        {
</span></span><span style="display:flex;"><span>            SynTcb <span style="color:#f92672">=</span> entry <span style="color:#f92672">-</span> <span style="color:#ae81ff">0x10</span>;
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">if</span> (SynTcb<span style="color:#f92672">-&gt;</span>Flags <span style="color:#f92672">&amp;</span> <span style="color:#ae81ff">1</span> <span style="color:#f92672">&amp;&amp;</span> SynTcb<span style="color:#f92672">-&gt;</span>AF <span style="color:#f92672">==</span> AfObject <span style="color:#f92672">&amp;&amp;</span> SynTcb<span style="color:#f92672">-&gt;</span>Compartment <span style="color:#f92672">==</span> CompartmentId)
</span></span><span style="display:flex;"><span>            {
</span></span><span style="display:flex;"><span>                KeyBuf[<span style="color:#f92672">*</span>Count] <span style="color:#f92672">=</span> { LocalAddr, LocalPort, RemoteAddr, RemotePort };
</span></span><span style="display:flex;"><span>                RwBuf[<span style="color:#f92672">*</span>Count]  <span style="color:#f92672">=</span> { PID, Timestamps <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span> };
</span></span><span style="display:flex;"><span>                RoBuf[<span style="color:#f92672">*</span>Count]  <span style="color:#f92672">=</span> <span style="color:#ae81ff">4</span>;   <span style="color:#75715e">// SYN_RECEIVED
</span></span></span><span style="display:flex;"><span>            }
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">// TIME_WAIT TCB (hash table [1])
</span></span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">RtlInitWeakEnumerationHashTable</span>(<span style="color:#f92672">&amp;</span>HashTables[<span style="color:#ae81ff">1</span>], <span style="color:#f92672">&amp;</span>Enum);
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">while</span> (entry <span style="color:#f92672">=</span> <span style="color:#a6e22e">RtlWeaklyEnumerateEntryHashTable</span>(<span style="color:#f92672">&amp;</span>HashTables[<span style="color:#ae81ff">1</span>], <span style="color:#f92672">&amp;</span>Enum))
</span></span><span style="display:flex;"><span>        {
</span></span><span style="display:flex;"><span>            TwTcb <span style="color:#f92672">=</span> entry;
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">if</span> (TwTcb<span style="color:#f92672">-&gt;</span>Active <span style="color:#f92672">&amp;&amp;</span> TwTcb<span style="color:#f92672">-&gt;</span>AF <span style="color:#f92672">==</span> AfObject <span style="color:#f92672">&amp;&amp;</span> TwTcb<span style="color:#f92672">-&gt;</span>Compartment <span style="color:#f92672">==</span> CompartmentId)
</span></span><span style="display:flex;"><span>            {
</span></span><span style="display:flex;"><span>                KeyBuf[<span style="color:#f92672">*</span>Count] <span style="color:#f92672">=</span> { LocalAddr, LocalPort, RemoteAddr, RemotePort};
</span></span><span style="display:flex;"><span>                RwBuf[<span style="color:#f92672">*</span>Count]  <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>;
</span></span><span style="display:flex;"><span>                RoBuf[<span style="color:#f92672">*</span>Count]  <span style="color:#f92672">=</span> <span style="color:#ae81ff">11</span>;   <span style="color:#75715e">// TIME_WAIT
</span></span></span><span style="display:flex;"><span>            }
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>Overall the <code>_TCB</code> definition looks like this:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#66d9ef">typedef</span> <span style="color:#66d9ef">struct</span> _IN_ADDR_DATA {
</span></span><span style="display:flex;"><span>    ULONG       Address;
</span></span><span style="display:flex;"><span>    PVOID       Next;
</span></span><span style="display:flex;"><span>    ULONG_PTR   Flags;
</span></span><span style="display:flex;"><span>} IN_ADDR_DATA, <span style="color:#f92672">*</span>PIN_ADDR_DATA;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">typedef</span> <span style="color:#66d9ef">struct</span> _LOCAL_ADDR_ENTRY {
</span></span><span style="display:flex;"><span>    PIN_ADDR_DATA IpData;
</span></span><span style="display:flex;"><span>    ULONG_PTR   Flags;
</span></span><span style="display:flex;"><span>    PVOID       Next;
</span></span><span style="display:flex;"><span>    PVOID       BackPtr;
</span></span><span style="display:flex;"><span>} LOCAL_ADDR_ENTRY, <span style="color:#f92672">*</span>PLOCAL_ADDR_ENTRY;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">typedef</span> <span style="color:#66d9ef">struct</span> _INET_LOCAL_ADDR {
</span></span><span style="display:flex;"><span>    ULONG_PTR   TagAndType;
</span></span><span style="display:flex;"><span>    PVOID       Unknown0;
</span></span><span style="display:flex;"><span>    PLOCAL_ADDR_ENTRY AddrEntry;
</span></span><span style="display:flex;"><span>    ULONG_PTR   Unknown1;
</span></span><span style="display:flex;"><span>} INET_LOCAL_ADDR, <span style="color:#f92672">*</span>PINET_LOCAL_ADDR;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">typedef</span> <span style="color:#66d9ef">struct</span> _TCP_ADDR_INFO {
</span></span><span style="display:flex;"><span>    PINET_LOCAL_ADDR LocalAddr; 
</span></span><span style="display:flex;"><span>    ULONG_PTR   LocalScopeFlags;
</span></span><span style="display:flex;"><span>    PIN_ADDR_DATA RemoteAddr;
</span></span><span style="display:flex;"><span>    ULONG       Flags;
</span></span><span style="display:flex;"><span>    ULONG       Unknown;
</span></span><span style="display:flex;"><span>} TCP_ADDR_INFO, <span style="color:#f92672">*</span>PTCP_ADDR_INFO;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">typedef</span> <span style="color:#66d9ef">struct</span> _TCB {
</span></span><span style="display:flex;"><span>    KSPIN_LOCK  Lock;                   <span style="color:#75715e">// 0x0
</span></span></span><span style="display:flex;"><span>    PTCP_ADDR_INFO AddrInfo;            <span style="color:#75715e">// 0x18
</span></span></span><span style="display:flex;"><span>    RTL_DYNAMIC_HASH_TABLE_ENTRY HashEntry; <span style="color:#75715e">// 0x28
</span></span></span><span style="display:flex;"><span>    LONG RefCount;                      <span style="color:#75715e">// 0x68
</span></span></span><span style="display:flex;"><span>    ULONG       InternalState;          <span style="color:#75715e">// 0x6C
</span></span></span><span style="display:flex;"><span>    USHORT      LocalPort;              <span style="color:#75715e">// 0x70
</span></span></span><span style="display:flex;"><span>    USHORT      RemotePort;             <span style="color:#75715e">// 0x72
</span></span></span><span style="display:flex;"><span>    ULONG       ValidationFlags;        <span style="color:#75715e">// 0x74  &amp; 4 means valid
</span></span></span><span style="display:flex;"><span>    UCHAR       LocalAddrType;          <span style="color:#75715e">// 0x2B0
</span></span></span><span style="display:flex;"><span>    UCHAR       RemoteAddrType;         <span style="color:#75715e">// 0x2B1
</span></span></span><span style="display:flex;"><span>    PEPROCESS   OwningProcess;          <span style="color:#75715e">// 0x2D8
</span></span></span><span style="display:flex;"><span>} TCB, <span style="color:#f92672">*</span>PTCB;
</span></span></code></pre></div><p>Now let&rsquo;s see this in action, let&rsquo;s enumerate IP addresses of live connections on WinDbg.</p>
<p>First reference the <code>tcpip!PartitionTable</code>, first entry is the SPIN_LOCK so jump onto the second entry, it is the first hash table entry of type <code>_RTL_DYNAMIC_HASH_TABLE</code></p>
<pre tabindex="0"><code>2: kd&gt; dt _RTL_DYNAMIC_HASH_TABLE poi(poi(tcpip!PartitionTable)+8)
ntdll!_RTL_DYNAMIC_HASH_TABLE
   +0x000 Flags            : 0
   +0x004 Shift            : 6
   +0x008 TableSize        : 0x80
   +0x00c Pivot            : 0
   +0x010 DivisorMask      : 0x7f
   +0x014 NumEntries       : 1
   +0x018 NonEmptyBuckets  : 1
   +0x01c NumEnumerators   : 0
   +0x020 Directory        : 0xffffc48d`3be0c010 Void

2: kd&gt; dq 0xffffc48d`3be0c010
ffffc48d`3be0c010  ffffc48d`3be0c010 ffffc48d`3be0c010
ffffc48d`3be0c020  ffffc48d`3be0c020 ffffc48d`3be0c020
ffffc48d`3be0c030  ffffc48d`3be0c030 ffffc48d`3be0c030
ffffc48d`3be0c040  ffffc48d`3be0c040 ffffc48d`3be0c040
ffffc48d`3be0c050  ffffc48d`3be0c050 ffffc48d`3be0c050
ffffc48d`3be0c060  ffffc48d`3be0c060 ffffc48d`3be0c060
ffffc48d`3be0c070  ffffc48d`3be0c070 ffffc48d`3be0c070
ffffc48d`3be0c080  ffffc48d`3be0c080 ffffc48d`3be0c080
</code></pre><p>All of them point to the head, this means that buckets are empty. I kept doing this for a while and there are really a lot of buckets to check, we need a script to find a bucket with data.</p>
<pre tabindex="0"><code>.block {
    r $t0 = poi(poi(tcpip!PartitionTable) + 8)
    r $t1 = poi(@$t0 + 0x20)
    r $t2 = dwo(@$t0 + 0x08)
    .for (r $t3 = 0; @$t3 &lt; @$t2; r $t3 = @$t3 + 1) {
        r $t4 = @$t1 + @$t3 * 0x10;
        r $t5 = poi(@$t4);
        .if (@$t5 != @$t4) {
            .printf &#34;Bucket:%p\n&#34;, @$t5
        }
    }
}
</code></pre><p>Which gave me only one results <code>ffffc48d426d9a48</code> , this is the <code>PRTL_DYNAMIC_HASH_TABLE_ENTRY</code> inside a valid <code>TCB</code> struct, which holds the information about the connection that it&rsquo;s going to return back to usermode.</p>
<p>Let&rsquo;s validate our findings:</p>
<pre tabindex="0"><code>1: kd&gt; r $t7 = ffffc48d426d9a48 - 0x28

1: kd&gt; dw @$t7 + 0x70 l2
ffffc48d`426d9a90  49c2 bb01 -&gt; local port: 49737 and remote port: 443

1: kd&gt; dw @$t7 + 0x6c l1
ffffc48d`426d9a8c  0004 -&gt; status: ESTABLISHED
</code></pre><p>Ip addresses are a bit tricky because remote address dereference just doesn&rsquo;t make sense at the first look, but many connections can bind to the local address, which makes it a shared object stored far from the TCB.</p>
<pre tabindex="0"><code>1: kd&gt; dq poi(poi(@$t7+0x18)+0x10) l1
ffffc48d`413feed0  00000000`b8854262 -&gt; remote addr: 98.66.133.184


1: kd&gt; dq poi(poi(poi(poi(@$t7+0x18))+0x10)) l1
ffffc48d`3bfe90c8  00000000`81e8a8c0 -&gt; local addr: 192.168.232.129

1: kd&gt; dq @$t7+0x2d8
ffffc48d`426d9cf8  ffffc48d`3ef30080 00000000`00000000
ffffc48d`426d9d08  01dc993a`0138eb89 00000000`00000102
ffffc48d`426d9d18  ffffc48d`411adc80 00000000`00000000
ffffc48d`426d9d28  ffffc48d`41229040 ffffc48d`42f16c40
ffffc48d`426d9d38  00000000`00000000 00000000`00000000
ffffc48d`426d9d48  00000000`00000000 00000000`00080008
ffffc48d`426d9d58  00000000`00000010 ffffc48d`426d9d68
ffffc48d`426d9d68  00000000`00000000 9e084b46`b0bee602

1: kd&gt; dt nt!_EPROCESS UniqueProcessId
   +0x440 UniqueProcessId : Ptr64 Void

1: kd&gt; dq ffffc48d`3ef30080 + 0x440 l1
ffffc48d`3ef304c0  00000000`00000bf4 -&gt; PID: 3060
</code></pre><p>Time to confirm with netstat:</p>
<p><img src="C:%5CUsers%5CDou%5CAppData%5CRoaming%5Cmarktext%5Cimages%5C2026-02-09-02-59-32-image.png" alt=""></p>
<p>Here is a script that iterates and prints the connections inside those hash tables: <a href="https://gist.github.com/xshiraori/c084ceb636f02616a549a3cb22ff0f39">Enumerate TCP Â· GitHub</a></p>

    </article>
  </div>

  
  
  

  
<link rel="stylesheet" type="text/css" href="//cdnjs.cloudflare.com/ajax/libs/cookieconsent2/3.1.0/cookieconsent.min.css" />
<script src="//cdnjs.cloudflare.com/ajax/libs/cookieconsent2/3.1.0/cookieconsent.min.js"></script>
<script>
window.addEventListener("load", function(){
window.cookieconsent.initialise({
  "palette": {
    "popup": {
      "background": "#216942",
      "text": "#b2d192"
    },
    "button": {
      "background": "#afed71"
    }
  }
})});
</script>

</body>

</html>
